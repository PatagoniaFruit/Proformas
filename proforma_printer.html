<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impresor de Proformas</title>
    <!-- Carga de SheetJS (para leer .xlsx) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
        }

        /* --- Estilos para la interfaz (no se imprimen) --- */
        .ui-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
        }
        
        /* Estilos de los botones y inputs */
        .btn-primary {
            @apply inline-flex items-center justify-center px-5 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-150 disabled:opacity-50 disabled:cursor-not-allowed;
        }
        
        .input-file-dropzone {
            @apply flex flex-col items-center justify-center w-full h-full px-4 py-6 text-center bg-white border-2 border-slate-300 border-dashed rounded-lg cursor-pointer hover:bg-slate-100 transition-colors duration-150;
        }
        .input-file-dropzone input[type="file"] {
            display: none;
        }

        .input-text-label {
             @apply block w-full px-4 py-3 text-sm text-slate-700 bg-slate-50 border border-slate-300 rounded-lg focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500;
        }
        
        /* .checkbox-label { ... } REMOVED */
        
        .checkbox-input {
             @apply h-4 w-4 text-indigo-600 border-slate-300 rounded focus:ring-indigo-500;
        }

        /* --- Estilos para la impresión --- */
        #printArea {
            display: none; /* Oculto por defecto */
        }
        
        .proforma-page {
            width: 210mm;
            height: 297mm; /* A4 */
            padding: 15mm;
            margin: 0 auto;
            background: white;
            color: #000;
            box-sizing: border-box; /* Importante para que el padding no afecte al tamaño */
            
            /* Clave para el layout de 1 página */
            display: flex;
            flex-direction: column;
        }
        
        @page {
            size: A4;
            margin: 0;
        }

        @media print {
            body, html {
                margin: 0;
                padding: 0;
                width: 210mm;
                height: 297mm;
            }
            
            /* Oculta la UI, muestra el área de impresión */
            .ui-container {
                display: none;
            }
            
            #printArea {
                display: block; /* Muestra solo al imprimir */
                margin: 0;
                padding: 0;
            }
            
            .proforma-page {
                box-shadow: none;
                border: none;
                margin: 0;
                padding: 15mm; /* Asegura el padding de impresión */
                page-break-after: always; /* Cada proforma en una hoja nueva */
            }
            
            /* Evita que el pie de página se corte */
            .proforma-footer {
                page-break-inside: avoid;
            }
            .totals-section {
                page-break-inside: avoid;
            }
        }

        /* --- Estilos del contenido de la proforma --- */
        .proforma-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
        }
        .proforma-header img {
            max-width: 180px; /* 180px o ~6.3cm */
            max-height: 80px;
            object-fit: contain;
        }
        .proforma-title-box {
            border: 2px solid #000;
            padding: 5px 20px;
            text-align: center;
        }
        .proforma-title {
            font-size: 16pt;
            font-weight: bold;
            letter-spacing: 1px;
            margin: 0;
        }
        .proforma-id {
            font-size: 12pt;
            font-weight: bold;
            margin: 0;
        }

        .customer-info {
            margin-top: 10px;
            font-size: 10pt;
        }
        .customer-info-table {
            border-collapse: collapse;
            width: 100%;
        }
        .customer-info-table td {
            padding: 3px 6px;
            vertical-align: top;
        }
        .customer-info-table .label {
            font-weight: bold;
            white-space: nowrap;
            padding-right: 5px;
            width: 1%; /* Forza a que la etiqueta ocupe lo mínimo */
        }
        .customer-info-table .data {
            border-bottom: 1px solid #000;
            /* width: 99%; <-- REMOVED */
        }
        
        /* Contenedor de la tabla (para el flex-grow) */
        .table-wrapper {
            margin-top: 10px;
            border: 2px solid #000;
            border-bottom: none; /* La última línea la pone la sección de totales */
            /* flex-grow: 1; <-- REMOVED */
            min-height: 100px; /* Altura mínima por si no hay items */
            /* display: flex; <-- REMOVED */
            /* flex-direction: column; <-- REMOVED */
        }

        .details-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed; /* Importante para que los anchos funcionen */
        }
        .details-table thead th {
            border-bottom: 2px solid #000;
            padding: 8px 5px;
            text-align: center;
            font-size: 10pt;
            font-weight: bold;
            background-color: #f0f0f0; /* Un gris ligero */
        }
        
        /* Cuerpo de la tabla (para que se estire) */
        .details-table tbody {
            font-size: 10pt;
            /* height: 100%; <-- REMOVED */
        }
        
        .details-table tbody tr:first-child td {
            padding-top: 8px; /* Espacio al inicio */
        }

        .details-table tbody tr td {
            padding: 4px 5px;
            vertical-align: top; /* Alinea items arriba */
        }
        
        /* Fila "invisible" que se estira para llenar el espacio */
        .details-table tbody tr.filler-row td {
            height: 100%;
            padding: 0;
            margin: 0;
            line-height: 0;
        }

        /* Columnas de la tabla */
        .col-cantidad { width: 15%; text-align: right; padding-right: 10px !important; }
        .col-detalle { width: 50%; }
        .col-punitario { width: 17.5%; text-align: right; padding-right: 10px !important; }
        .col-total { width: 17.5%; text-align: right; padding-right: 10px !important; }

        /* Sección de Totales (abajo) */
        .totals-section {
            display: flex;
            border: 2px solid #000;
            font-size: 10pt;
            font-weight: bold;
            flex-shrink: 0; /* <-- ¡CLAVE! No se achica */
        }
        .totals-glosa {
            width: 65%;
            padding: 8px 5px;
            border-right: 2px solid #000;
            min-height: 80px; /* Altura mínima para la glosa */
        }
        .totals-table {
            width: 35%;
        }
        .totals-table table {
            width: 100%;
            border-collapse: collapse;
        }
        .totals-table td {
            padding: 5px 10px;
        }
        .totals-table .label {
            text-align: left;
        }
        .totals-table .value {
            text-align: right;
        }
        .totals-table tr:not(:last-child) td {
             border-bottom: 1px solid #000;
        }

        /* Pie de página */
        .proforma-footer {
            margin-top: 10px;
            border: 2px solid #000;
            padding: 10px 15px;
            font-size: 9pt;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-shrink: 0; /* <-- ¡CLAVE! No se achica */
        }
        .footer-column {
            width: 48%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 50px; /* Altura para el bloque */
        }
        .footer-line {
            display: flex;
        }
        .footer-line .label {
             font-weight: bold;
             padding-right: 5px;
             white-space: nowrap;
        }
        .footer-line .data {
            border-bottom: 1px solid #000;
            width: 100%;
        }

    </style>
</head>
<body>

    <!-- Interfaz de Usuario (UI) -->
    <div class="ui-container">
        
        <h1 class="text-3xl font-bold text-slate-900 mb-6">Impresor de Proformas</h1>
        
        <!-- Zona de Carga -->
        <div class="mb-8 p-6 bg-slate-50 rounded-xl border border-slate-200">
            <h2 class="text-xl font-semibold text-slate-800 mb-5">1. Cargar Archivos</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Cargar Excel -->
                <div>
                    <label for="fileInput" class="input-file-dropzone">
                        <svg class="w-10 h-10 text-gray-400 mx-auto mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m.75 12l3 3m0 0l3-3m-3 3v-6m-1.5-9H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                        </svg>
                        <span class="font-medium text-indigo-600">Cargar archivo Excel</span>
                        <span class="text-sm text-slate-500 mt-1" id="file-name">o arrastrar y soltar (.xlsx)</span>
                        <input id="fileInput" type="file" accept=".xlsx, .xls" onchange="handleFile(event)">
                    </label>
                </div>
                
                <!-- Cargar Logo -->
                <div>
                    <label for="logoInput" class="input-file-dropzone">
                         <svg class="w-10 h-10 text-slate-400 mx-auto mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm16.5-1.5H3.75v-1.5m16.5 0v1.5m0 0v-1.5m0 0h-16.5" />
                         </svg>
                        <span class="font-medium text-indigo-600">Cargar logo (Opcional)</span>
                        <span class="text-sm text-slate-500 mt-1" id="logo-file-name">o arrastrar y soltar (.png, .jpg)</span>
                        <input id="logoInput" type="file" accept="image/*" onchange="handleLogo(event)">
                    </label>
                </div>
            </div>
        </div>

        <!-- Mensaje de Error -->
        <div id="errorMessage" class="hidden p-4 mb-4 text-sm text-red-700 bg-red-100 rounded-lg" role="alert">
            <!-- Mensaje de error aquí -->
        </div>

        <!-- Separador -->
        <hr class="my-8 border-slate-200">

        <!-- Lista de Proformas -->
        <div class="mb-8">
            <h2 class="text-xl font-semibold text-slate-800 mb-5">2. Seleccionar Proformas</h2>
            
            <div id="proformaListContainer" class="relative overflow-hidden border border-slate-200 rounded-lg">
                <div class="max-h-64 overflow-y-auto">
                    <table class="w-full text-sm text-left text-slate-500">
                        <thead class="text-xs text-slate-700 uppercase bg-slate-100 sticky top-0">
                            <tr>
                                <th scope="col" class="p-4">
                                    <input type="checkbox" id="selectAllCheckbox" class="checkbox-input">
                                </th>
                                <th scope="col" class="px-6 py-3">
                                    ID Proforma
                                </th>
                                <th scope="col" class="px-6 py-3">
                                    Cliente
                                </th>
                            </tr>
                        </thead>
                        <tbody id="proformaListBody">
                            <!-- Filas generadas por JS -->
                            <tr>
                                <td colspan="3" class="px-6 py-4 text-center text-slate-500">
                                    Carga un archivo Excel para ver las proformas disponibles.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Separador -->
        <hr class="my-8 border-slate-200">

        <!-- Botón de Imprimir -->
        <div>
            <h2 class="text-xl font-semibold text-slate-800 mb-5">3. Generar Impresión</h2>
            <button id="printButton" onclick="printSelected()" class="btn-primary w-full" disabled>
                <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6.72 13.829c-.24.03-.48.062-.72.096m.72-.096a42.415 42.415 0 0110.56 0m-10.56 0L6 13.828m0 0l-.071.007M6 13.828l.071-.007m0 0l.071.007m0 0l-.071-.007M12.75 8.25c.24.03.48.062.72.096m-.72-.096a42.415 42.415 0 00-10.56 0m10.56 0L12 8.25m0 0l.071.007M12 8.25l-.071-.007m0 0l-.071.007m0 0l.071-.007M6.75 7.5h.008v.008H6.75V7.5zm.375 0h.008v.008h-.008V7.5zm.375 0h.008v.008h-.008V7.5zm.375 0h.008v.008h-.008V7.5zm.375 0h.008v.008h-.008V7.5zm.375 0h.008v.008h-.008V7.5zm.375 0h.008v.008h-.008V7.5zm.375 0h.008v.008h-.008V7.5zm.375 0h.008v.008h-.008V7.5zm.375 0h.008v.008h-.008V7.5zm.375 0h.008v.008h-.008V7.5zm.375 0h.008v.008h-.008V7.5zM17.25 7.5h.008v.008h-.008V7.5zm.375 0h.008v.008h-.008V7.5zm.375 0h.008v.008h-.008V7.5zm.375 0h.008v.008h-.008V7.5zm.375 0h.008v.008h-.008V7.5zm.375 0h.008v.008h-.008V7.5zm.375 0h.008v.008h-.008V7.5zm.375 0h.008v.008h-.008V7.5zm.375 0h.008v.008h-.008V7.5zm.375 0h.008v.008h-.008V7.5zm.375 0h.008v.008h-.008V7.5zm.375 0h.008v.008h-.008V7.5z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 18.75h-9a2.25 2.25 0 00-2.25 2.25v.003c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V21a2.25 2.25 0 00-2.25-2.25z" />
                </svg>
                Imprimir Seleccionadas
            </button>
        </div>
    </div>

    <!-- Área de Impresión (Oculta) -->
    <div id="printArea">
        <!-- Las proformas generadas se insertarán aquí -->
    </div>

    <script>
        let proformaData = {}; // Guarda los datos agrupados
        let logoDataUrl = null; // Guarda el logo como Data URL

        // Formateadores de moneda y números
        // CLP (Pesos Chilenos) no usa decimales para los totales
        const currencyFormatter = new Intl.NumberFormat('es-CL', {
            style: 'currency',
            currency: 'CLP',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0,
        });
        
        // Formateador de número para P.UNITARIO (con 2 decimales)
        const numberFormatter = new Intl.NumberFormat('es-ES', {
            style: 'decimal',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
        });
        
        // Formateador de número para Cantidad (con 2 decimales)
        const quantityFormatter = new Intl.NumberFormat('es-ES', {
            style: 'decimal',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
        });

        function showMessage(type, message) {
            const errorDiv = document.getElementById('errorMessage');
            if (type === 'error') {
                errorDiv.classList.remove('hidden', 'bg-green-100', 'text-green-700');
                errorDiv.classList.add('bg-red-100', 'text-red-700');
                errorDiv.innerHTML = `<span class="font-medium">Error:</span> ${message}`;
            } else if (type === 'success') {
                errorDiv.classList.remove('hidden', 'bg-red-100', 'text-red-700');
                errorDiv.classList.add('bg-green-100', 'text-green-700');
                errorDiv.innerHTML = `<span class="font-medium">Éxito:</span> ${message}`;
            } else {
                errorDiv.classList.add('hidden');
            }
        }

        function handleLogo(event) {
            const file = event.target.files[0];
            const labelSpan = document.getElementById('logo-file-name');
            if (!file) {
                labelSpan.textContent = 'o arrastrar y soltar (.png, .jpg)'; // Reset
                return;
            }

            labelSpan.textContent = file.name; // Show file name

            const reader = new FileReader();
            reader.onload = function(e) {
                logoDataUrl = e.target.result; // Guarda la URL de datos base64
                showMessage('success', `Logo "${file.name}" cargado correctamente.`);
            };
            reader.onerror = function() {
                showMessage('error', `No se pudo leer el archivo de logo.`);
                logoDataUrl = null;
            };
            reader.readAsDataURL(file);
        }

        function handleFile(event) {
            const file = event.target.files[0];
            const labelSpan = document.getElementById('file-name');
            if (!file) {
                labelSpan.textContent = 'o arrastrar y soltar (.xlsx)'; // Reset
                return;
            }

            labelSpan.textContent = file.name; // Show file name
            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true }); // 'cellDates: true' es importante
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // Convertir a JSON, 'raw: false' formatea fechas y números
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: false });

                    processData(jsonData);
                    
                } catch (err) {
                    console.error("Error al leer el archivo XLSX:", err);
                    showMessage('error', `Error al leer el archivo: ${err.message}. Asegúrate de que sea un archivo .xlsx válido.`);
                }
            };
            
            reader.onerror = function() {
                showMessage('error', `No se pudo leer el archivo.`);
            };

            reader.readAsArrayBuffer(file);
        }
        
        function normalizeKey(key) {
            // Quita espacios, convierte a mayúsculas y quita acentos/caracteres especiales
            return (key || '').trim().toUpperCase()
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        }

        function processData(data) {
            proformaData = {};
            
            if (data.length === 0) {
                showMessage('error', 'El archivo Excel está vacío.');
                return;
            }

            // Normaliza las claves del primer objeto para la validación
            const headers = Object.keys(data[0]).map(normalizeKey);
            const requiredCols = ['ID_PROFORMA', 'SENORES', 'FECHA', 'CANTIDAD', 'DETALLE', 'PUNITARIO'];
            
            for (const col of requiredCols) {
                if (!headers.includes(col)) {
                    showMessage('error', `La columna requerida "${col}" no se encontró en tu archivo Excel. Revisa los encabezados.`);
                    return;
                }
            }

            data.forEach(row => {
                // Crea una copia normalizada de la fila
                const normalizedRow = {};
                for (const key in row) {
                    normalizedRow[normalizeKey(key)] = row[key];
                }

                const id = normalizedRow.ID_PROFORMA;
                if (!id) return; // Ignora filas sin ID

                if (!proformaData[id]) {
                    // Si es la primera vez que vemos este ID, guardamos la cabecera
                    proformaData[id] = {
                        header: normalizedRow,
                        items: []
                    };
                }
                
                // Parseamos los números (con coma decimal)
                const cantidad = parseFloat(String(normalizedRow.CANTIDAD).replace(',', '.')) || 0;
                const pUnitario = parseFloat(String(normalizedRow.PUNITARIO).replace(',', '.')) || 0;
                
                // Añadimos el item
                proformaData[id].items.push({
                    CANTIDAD: cantidad,
                    DETALLE: normalizedRow.DETALLE,
                    PUNITARIO: pUnitario,
                    TOTAL: cantidad * pUnitario
                });
            });

            updateProformaList();
            showMessage('success', `Se encontraron ${Object.keys(proformaData).length} proformas únicas.`);
        }

        function updateProformaList() {
            const listBody = document.getElementById('proformaListBody');
            const listContainer = document.getElementById('proformaListContainer');
            const printButton = document.getElementById('printButton');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            
            if (Object.keys(proformaData).length === 0) {
                listBody.innerHTML = `
                    <tr>
                        <td colspan="3" class="px-6 py-4 text-center text-slate-500">
                            No se encontraron datos de proformas en el archivo.
                        </td>
                    </tr>
                `;
                printButton.disabled = true;
                selectAllCheckbox.disabled = true;
                return;
            }

            listBody.innerHTML = ''; // Limpia la lista
            selectAllCheckbox.disabled = false;
            selectAllCheckbox.checked = false; // Desmarca por si acaso

            // Proformas individuales
            for (const id in proformaData) {
                const proforma = proformaData[id];
                const tr = document.createElement('tr');
                tr.className = 'bg-white border-b hover:bg-slate-50';
                tr.innerHTML = `
                    <td class="w-4 p-4">
                        <input type="checkbox" class="checkbox-input proforma-checkbox" value="${id}">
                    </td>
                    <th scope="row" class="px-6 py-3 font-medium text-slate-900 whitespace-nowrap">
                        ${id}
                    </th>
                    <td class="px-6 py-3 truncate" style="max-width: 20rem;">
                        ${proforma.header.SENORES}
                    </td>
                `;
                listBody.appendChild(tr);
            }
            
            // Habilita el botón de imprimir
            printButton.disabled = false;
            
            // Lógica del "Seleccionar Todos"
            selectAllCheckbox.addEventListener('change', (e) => {
                listBody.querySelectorAll('.proforma-checkbox').forEach(cb => {
                    cb.checked = e.target.checked;
                });
            });
        }

        function createProformaPage(proforma, id) {
            const page = document.createElement('div');
            page.className = 'proforma-page';

            const { header } = proforma;
            
            // Calcula totales
            let valorNeto = 0;
            
            // Genera las filas de la tabla de items
            const itemsRows = proforma.items.map(item => {
                valorNeto += item.TOTAL;
                return `
                    <tr>
                        <td class="col-cantidad">${quantityFormatter.format(item.CANTIDAD)}</td>
                        <td class="col-detalle">${item.DETALLE || ''}</td>
                        <td class="col-punitario">$${numberFormatter.format(item.PUNITARIO)}</td>
                        <td class="col-total">${currencyFormatter.format(item.TOTAL)}</td>
                    </tr>
                `;
            }).join('');
            
            // Calcula IVA y Total
            const iva = valorNeto * 0.19;
            const total = valorNeto + iva;
            
            // Formatea la fecha
            const meses = [
                "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", 
                "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
            ];
            let dia = '', mesNum = '', ano = '';
            
            // SheetJS puede devolver la fecha como un string 'dd/mm/yyyy' o 'dd-mm-yyyy'
            const fechaStr = String(header.FECHA || '').split(' ')[0]; // Toma solo la parte de la fecha

            if (fechaStr.includes('-')) {
                [dia, mesNum, ano] = fechaStr.split('-');
            } else if (fechaStr.includes('/')) {
                [dia, mesNum, ano] = fechaStr.split('/');
            }
            
            // Si dia, mes, ano son incorrectos, podría ser un número de serie de Excel
            // Pero confiamos en que 'cellDates:true' y 'raw:false' lo han formateado
            
            dia = String(dia || '').padStart(2, '0');
            const mesNombre = meses[parseInt(mesNum, 10) - 1] || mesNum || ''; // <-- Obtiene nombre del mes
            ano = ano || '2025';


            page.innerHTML = `
                <!-- Cabecera: Logo y Título -->
                <header class="proforma-header">
                    <img src="${logoDataUrl || 'https://placehold.co/180x80/eee/ccc?text=Logo'}" alt="Logo">
                    <div class="proforma-title-box">
                        <h2 class="proforma-title">FACTURA PROFORMA</h2>
                        <p class="proforma-id">Nº ${id}</p>
                    </div>
                </header>

                <!-- Info Cliente -->
                <section class="customer-info">
                    <div style="display: flex; justify-content: flex-start; margin-bottom: 5px; padding: 3px 6px;">
                        <span class="label" style="width: auto; padding-right: 5px;">FECHA,</span>
                        <span class="data" style="border-bottom: 1px solid #000; width: 50px; text-align: center;">${dia}</span>
                        <span style="padding: 0 5px;">de</span>
                        <span class="data" style="border-bottom: 1px solid #000; width: 100px; text-align: center;">${mesNombre}</span>
                        <span style="padding: 0 5px;">de</span>
                        <span class="data" style="border-bottom: 1px solid #000; width: 60px; text-align: center;">${ano}</span>
                    </div>
                
                    <div class="customer-info-table">
                        <table style="width: 100%;">
                            <tbody>
                                <tr>
                                    <td class="label">SEÑORES:</td>
                                    <td class="data">${header.SENORES || ''}</td>
                                    <td class="label" style="padding-left: 10px;">CIUDAD:</td>
                                    <td class="data">${header.CIUDAD || ''}</td>
                                </tr>
                                <tr>
                                    <td class="label">DIRECCION:</td>
                                    <td class="data">${header.DIRECCION || ''}</td>
                                    <td class="label" style="padding-left: 10px;">CREDITO:</td>
                                    <td class="data">${header.CREDITO || ''}</td>
                                </tr>
                                <tr>
                                    <td class="label">GIRO:</td>
                                    <td class="data">${header.GIRO || ''}</td>
                                    <td class="label" style="padding-left: 10px;">TELEFONO:</td>
                                    <td class="data">${header.TELEFONO || ''}</td>
                                </tr>
                                <tr>
                                    <td class="label">R.U.T.:</td>
                                    <td class="data">${header.RUT || ''}</td>
                                    <td colspan="2"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>
                
                <!-- Contenedor de Tabla (para flex-grow) -->
                <div class="table-wrapper">
                    <table class="details-table">
                        <thead>
                            <tr>
                                <th class="col-cantidad">CANTIDAD</th>
                                <th class="col-detalle">DETALLE</th>
                                <th class="col-punitario">P.UNITARIO</th>
                                <th class="col-total">TOTAL</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsRows}
                            <!-- Fila de relleno para empujar contenido hacia arriba -->
                            <!-- <tr class="filler-row"> ... </tr>  REMOVED -->
                        </tbody>
                    </table>
                </div>

                <!-- Espaciador que empuja el contenido hacia abajo -->
                <div style="flex-grow: 1; min-height: 20px;"></div>

                <!-- Totales y Glosa -->
                <section class="totals-section">
                    <div class="totals-glosa">
                        <span style="font-weight: bold;">GLOSA:</span>
                        <div style="font-weight: normal; padding-left: 10px; margin-top: 5px;">
                            ${header.GLOSA || ''}
                        </div>
                    </div>
                    <div class="totals-table">
                        <table>
                            <tbody>
                                <tr>
                                    <td class="label">VALOR NETO</td>
                                    <td class="value">${currencyFormatter.format(valorNeto)}</td>
                                </tr>
                                <tr>
                                    <td class="label">19% IVA</td>
                                    <td class="value">${currencyFormatter.format(iva)}</td>
                                </tr>
                                <tr>
                                    <td class="label">TOTAL</td>
                                    <td class="value">${currencyFormatter.format(total)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Pie de página -->
                <footer class="proforma-footer">
                    <div class="footer-column">
                        <span style="font-weight: bold;">RECIBI CONFORME</span>
                        <div class="footer-line">
                            <span class="label">R.U.T.:</span>
                            <span class="data">&nbsp;</span>
                        </div>
                    </div>
                    <div class="footer-column">
                        <div class="footer-line">
                            <span class="label">NOMBRE:</span>
                            <span class="data">&nbsp;</span>
                        </div>
                        <div class="footer-line" style="margin-top: 10px;">
                            <span class="label">FIRMA:</span>
                            <span class="data">&nbsp;</span>
                        </div>
                    </div>
                </footer>
            `;

            return page;
        }

        function printSelected() {
            const selectedCheckboxes = document.querySelectorAll('.proforma-checkbox:checked');
            const printArea = document.getElementById('printArea');
            
            printArea.innerHTML = ''; // Limpia el área de impresión

            if (selectedCheckboxes.length === 0) {
                showMessage('error', 'Debes seleccionar al menos una proforma para imprimir.');
                return;
            }

            selectedCheckboxes.forEach(cb => {
                const id = cb.value;
                const data = proformaData[id];
                if (data) {
                    const page = createProformaPage(data, id);
                    printArea.appendChild(page);
                }
            });

            // Llama a la impresión del navegador
            window.print();
        }

    </script>
</body>
</html>