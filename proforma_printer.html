<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Impresor de Proformas</title>

  <!-- SheetJS (para leer .xlsx) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Tailwind CDN (solo utilidades en runtime; NO usa @apply) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    :root {
      --ring: rgba(99, 102, 241, 0.5);
    }
    body {
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background-color: #f1f5f9; /* slate-100 */
      color: #0f172a; /* slate-900 */
    }

    /* ====== Estilos propios (sin @apply) ====== */
    .ui-container {
      max-width: 900px;
      margin: 2rem auto;
      padding: 2rem;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.06);
    }
    .btn-primary {
      display: inline-flex; align-items: center; justify-content: center;
      width: 100%;
      padding: 0.8rem 1.2rem;
      font-weight: 600; font-size: 1rem;
      color: #fff; background: #4f46e5; border: 1px solid transparent;
      border-radius: 0.75rem;
      box-shadow: 0 4px 10px rgba(79, 70, 229, 0.2);
      transition: background 120ms, transform 120ms, box-shadow 120ms;
      cursor: pointer;
    }
    .btn-primary:hover { background: #4338ca; }
    .btn-primary:active { transform: translateY(1px); box-shadow: 0 2px 6px rgba(79,70,229,.25); }
    .btn-primary:disabled { opacity: .5; cursor: not-allowed; }

    .input-file-dropzone {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      width: 100%; min-height: 160px; padding: 1.25rem;
      text-align: center;
      background: #fff; border: 2px dashed #cbd5e1; border-radius: 0.75rem;
      transition: background 120ms, border-color 120ms;
      cursor: pointer;
    }
    .input-file-dropzone:hover { background: #f8fafc; border-color: #94a3b8; }
    .input-file-dropzone input[type="file"] { display: none; }

    .checkbox-input { width: 1rem; height: 1rem; border-radius: .25rem; border: 1px solid #cbd5e1; }

    /* ====== Área de impresión ====== */
    #printArea { display: none; }
    .proforma-page {
      width: 210mm; height: 297mm; /* A4 */
      padding: 15mm; margin: 0 auto; background: #fff; color: #000; box-sizing: border-box;
      display: flex; flex-direction: column;
    }
    @page { size: A4; margin: 0; }
    @media print {
      html, body { width: 210mm; height: 297mm; margin: 0; padding: 0; }
      .ui-container { display: none; }
      #printArea { display: block; margin: 0; padding: 0; }
      .proforma-page { box-shadow: none; border: none; margin: 0; padding: 15mm; page-break-after: always; }
      .proforma-footer, .totals-section { page-break-inside: avoid; }
    }

    /* ====== Contenido Proforma ====== */
    .proforma-header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid #000; padding-bottom: 10px; }
    .proforma-header img { max-width: 180px; max-height: 80px; object-fit: contain; }
    .proforma-title-box { border: 2px solid #000; padding: 6px 18px; text-align: center; }
    .proforma-title { font-size: 16pt; font-weight: 800; margin: 0; letter-spacing: .5px; }
    .proforma-id { font-size: 12pt; font-weight: 700; margin: 0; }

    .customer-info { margin-top: 10px; font-size: 10pt; }
    .customer-info-table { border-collapse: collapse; width: 100%; }
    .customer-info-table td { padding: 3px 6px; vertical-align: top; }
    .customer-info-table .label { font-weight: 700; white-space: nowrap; padding-right: 5px; width: 1%; }
    .customer-info-table .data { border-bottom: 1px solid #000; }

    .table-wrapper { margin-top: 10px; border: 2px solid #000; border-bottom: none; min-height: 100px; }
    .details-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
    .details-table thead th { border-bottom: 2px solid #000; padding: 8px 5px; text-align: center; font-size: 10pt; font-weight: 700; background: #f0f0f0; }
    .details-table tbody { font-size: 10pt; }
    .details-table tbody tr:first-child td { padding-top: 8px; }
    .details-table tbody tr td { padding: 4px 5px; vertical-align: top; }

    .col-cantidad { width: 15%; text-align: right; padding-right: 10px !important; }
    .col-detalle { width: 50%; }
    .col-punitario { width: 17.5%; text-align: right; padding-right: 10px !important; }
    .col-total { width: 17.5%; text-align: right; padding-right: 10px !important; }

    .totals-section { display: flex; border: 2px solid #000; font-size: 10pt; font-weight: 700; flex-shrink: 0; }
    .totals-glosa { width: 65%; padding: 8px 5px; border-right: 2px solid #000; min-height: 80px; }
    .totals-table { width: 35%; }
    .totals-table table { width: 100%; border-collapse: collapse; }
    .totals-table td { padding: 5px 10px; }
    .totals-table .label { text-align: left; }
    .totals-table .value { text-align: right; }
    .totals-table tr:not(:last-child) td { border-bottom: 1px solid #000; }

    .proforma-footer { margin-top: 10px; border: 2px solid #000; padding: 10px 15px; font-size: 9pt; display: flex; justify-content: space-between; align-items: flex-start; flex-shrink: 0; }
    .footer-column { width: 48%; display: flex; flex-direction: column; justify-content: space-between; height: 50px; }
    .footer-line { display: flex; }
    .footer-line .label { font-weight: 700; padding-right: 5px; white-space: nowrap; }
    .footer-line .data { border-bottom: 1px solid #000; width: 100%; }
  </style>
</head>
<body>
  <!-- ====== UI ====== -->
  <div class="ui-container">
    <h1 class="text-3xl font-bold mb-6">Impresor de Proformas</h1>

    <!-- Carga de archivos -->
    <div class="mb-8 p-6 bg-slate-50 rounded-xl border border-slate-200">
      <h2 class="text-xl font-semibold mb-5">1. Cargar Archivos</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label for="fileInput" class="input-file-dropzone">
            <svg class="w-10 h-10 text-gray-400 mx-auto mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m.75 12l3 3m0 0l3-3m-3 3v-6m-1.5-9H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
            <span class="font-medium text-indigo-600">Cargar archivo Excel</span>
            <span class="text-sm text-slate-500 mt-1" id="file-name">o arrastrar y soltar (.xlsx)</span>
            <input id="fileInput" type="file" accept=".xlsx, .xls" />
          </label>
        </div>
        <div>
          <label for="logoInput" class="input-file-dropzone">
            <svg class="w-10 h-10 text-slate-400 mx-auto mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm16.5-1.5H3.75v-1.5m16.5 0v1.5m0 0v-1.5m0 0h-16.5" /></svg>
            <span class="font-medium text-indigo-600">Cargar logo (Opcional)</span>
            <span class="text-sm text-slate-500 mt-1" id="logo-file-name">o arrastrar y soltar (.png, .jpg)</span>
            <input id="logoInput" type="file" accept="image/*" />
          </label>
        </div>
      </div>
    </div>

    <div id="errorMessage" class="hidden p-4 mb-4 text-sm rounded-lg" role="alert"></div>

    <hr class="my-8 border-slate-200" />

    <!-- Selección de proformas -->
    <div class="mb-8">
      <h2 class="text-xl font-semibold mb-5">2. Seleccionar Proformas</h2>
      <div id="proformaListContainer" class="relative overflow-hidden border border-slate-200 rounded-lg">
        <div class="max-h-64 overflow-y-auto">
          <table class="w-full text-sm text-left text-slate-600">
            <thead class="text-xs text-slate-700 uppercase bg-slate-100 sticky top-0">
              <tr>
                <th class="p-4"><input type="checkbox" id="selectAllCheckbox" class="checkbox-input" /></th>
                <th class="px-6 py-3">ID Proforma</th>
                <th class="px-6 py-3">Cliente</th>
              </tr>
            </thead>
            <tbody id="proformaListBody">
              <tr>
                <td colspan="3" class="px-6 py-4 text-center text-slate-500">Carga un archivo Excel para ver las proformas disponibles.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <hr class="my-8 border-slate-200" />

    <!-- Imprimir -->
    <div>
      <h2 class="text-xl font-semibold mb-5">3. Generar Impresión</h2>
      <button id="printButton" class="btn-primary" disabled>
        <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.72 13.829c-.24.03-.48.062-.72.096m.72-.096a42.415 42.415 0 0110.56 0m-10.56 0L6 13.828m0 0l-.071.007M6 13.828l.071-.007m0 0l.071.007m0 0l-.071-.007M12.75 8.25c.24.03.48.062.72.096m-.72-.096a42.415 42.415 0 00-10.56 0m10.56 0L12 8.25m0 0l.071.007M12 8.25l-.071-.007m0 0l-.071.007m0 0l.071-.007M6.75 7.5h.008v.008H6.75V7.5zm.375 0h.008v.008h-.008V7.5zm.375 0h.008v.008h-.008V7.5zm.375 0h.008v.008h-.008V7.5zm.375 0h.008v.008h-.008V7.5zm.375 0h.008v.008h-.008V7.5zm.375 0h.008v.008h-.008V7.5zm.375 0h.008v.008h-.008V7.5zm.375 0h.008v.008h-.008V7.5zm.375 0h.008v.008h-.008V7.5zm.375 0h.008v.008h-.008V7.5zm.375 0h.008v.008h-.008V7.5zM17.25 7.5h.008v.008h-.008V7.5zm.375 0h.008v.008h-.008V7.5zm.375 0h.008v.008h-.008V7.5zm.375 0h.008v.008h-.008V7.5zm.375 0h.008v.008h-.008V7.5zm.375 0h.008v.008h-.008V7.5zm.375 0h.008v.008h-.008V7.5zm.375 0h.008v.008h-.008V7.5zm.375 0h.008v.008h-.008V7.5zm.375 0h.008v.008h-.008V7.5zm.375 0h.008v.008h-.008V7.5zm.375 0h.008v.008h-.008V7.5z" /><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 18.75h-9a2.25 2.25 0 00-2.25 2.25v.003c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V21a2.25 2.25 0 00-2.25-2.25z" /></svg>
        Imprimir seleccionadas
      </button>
    </div>
  </div>

  <!-- Área de impresión -->
  <div id="printArea"></div>

  <script>
    let proformaData = {};
    let logoDataUrl = null;

    // ====== Formateadores ======
    const currencyFormatter = new Intl.NumberFormat('es-CL', {
      style: 'currency', currency: 'CLP', minimumFractionDigits: 0, maximumFractionDigits: 0,
    });
    const numberFormatter = new Intl.NumberFormat('es-ES', {
      style: 'decimal', minimumFractionDigits: 2, maximumFractionDigits: 2,
    });
    const quantityFormatter = new Intl.NumberFormat('es-ES', {
      style: 'decimal', minimumFractionDigits: 2, maximumFractionDigits: 2,
    });

    // ====== Util: mensajes ======
    function showMessage(type, message) {
      const box = document.getElementById('errorMessage');
      box.classList.remove('hidden');
      box.textContent = message;
      if (type === 'error') {
        box.className = 'p-4 mb-4 text-sm rounded-lg bg-red-100 text-red-700';
      } else if (type === 'success') {
        box.className = 'p-4 mb-4 text-sm rounded-lg bg-green-100 text-green-700';
      } else {
        box.className = 'hidden';
      }
    }

    // ====== Logo ======
    document.getElementById('logoInput').addEventListener('change', (event) => {
      const file = event.target.files?.[0];
      const labelSpan = document.getElementById('logo-file-name');
      if (!file) { labelSpan.textContent = 'o arrastrar y soltar (.png, .jpg)'; return; }
      labelSpan.textContent = file.name;
      const reader = new FileReader();
      reader.onload = (e) => { logoDataUrl = e.target.result; showMessage('success', `Logo "${file.name}" cargado correctamente.`); };
      reader.onerror = () => { logoDataUrl = null; showMessage('error', 'No se pudo leer el archivo de logo.'); };
      reader.readAsDataURL(file);
    });

    // ====== Excel ======
    document.getElementById('fileInput').addEventListener('change', (event) => {
      const file = event.target.files?.[0];
      const labelSpan = document.getElementById('file-name');
      if (!file) { labelSpan.textContent = 'o arrastrar y soltar (.xlsx)'; return; }
      labelSpan.textContent = file.name;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array', cellDates: true });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(sheet, { raw: false });
          processData(json);
        } catch (err) {
          console.error(err);
          showMessage('error', `Error al leer el archivo: ${err.message}`);
        }
      };
      reader.onerror = () => showMessage('error', 'No se pudo leer el archivo.');
      reader.readAsArrayBuffer(file);
    });

    function normalizeKey(key) {
      return (key || '').trim().toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    }

    function processData(rows) {
      proformaData = {};
      if (!rows?.length) { showMessage('error', 'El archivo Excel está vacío.'); return; }
      const headers = Object.keys(rows[0]).map(normalizeKey);
      const required = ['ID_PROFORMA', 'SENORES', 'FECHA', 'CANTIDAD', 'DETALLE', 'PUNITARIO'];
      for (const col of required) {
        if (!headers.includes(col)) { showMessage('error', `Falta la columna "${col}".`); return; }
      }

      rows.forEach((row) => {
        const r = {}; Object.keys(row).forEach(k => r[normalizeKey(k)] = row[k]);
        const id = r.ID_PROFORMA; if (!id) return;
        if (!proformaData[id]) proformaData[id] = { header: r, items: [] };
        const cantidad = parseFloat(String(r.CANTIDAD).replace(',', '.')) || 0;
        const pUnit = parseFloat(String(r.PUNITARIO).replace(',', '.')) || 0;
        proformaData[id].items.push({ CANTIDAD: cantidad, DETALLE: r.DETALLE, PUNITARIO: pUnit, TOTAL: cantidad * pUnit });
      });

      updateProformaList();
      showMessage('success', `Se encontraron ${Object.keys(proformaData).length} proformas únicas.`);
    }

    function updateProformaList() {
      const body = document.getElementById('proformaListBody');
      const btn = document.getElementById('printButton');
      const all = document.getElementById('selectAllCheckbox');

      if (!Object.keys(proformaData).length) {
        body.innerHTML = '<tr><td colspan="3" class="px-6 py-4 text-center text-slate-500">No se encontraron datos.</td></tr>'; btn.disabled = true; all.disabled = true; return;
      }
      body.innerHTML = '';
      btn.disabled = false; all.disabled = false; all.checked = false;

      for (const id in proformaData) {
        const pf = proformaData[id];
        const tr = document.createElement('tr');
        tr.className = 'bg-white border-b hover:bg-slate-50';
        tr.innerHTML = `
          <td class="w-4 p-4"><input type="checkbox" class="checkbox-input proforma-checkbox" value="${id}" /></td>
          <th class="px-6 py-3 font-semibold text-slate-900 whitespace-nowrap">${id}</th>
          <td class="px-6 py-3 truncate" style="max-width: 20rem;">${pf.header.SENORES || ''}</td>`;
        body.appendChild(tr);
      }

      all.onchange = (e) => {
        body.querySelectorAll('.proforma-checkbox').forEach(cb => cb.checked = e.target.checked);
      };

      document.getElementById('printButton').onclick = printSelected;
    }

    // ====== FECHAS: parseo robusto + salida chilena (DD de Mes de AAAA) ======
    const MESES = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];

    function normalizeYear(y) { y = Number(y); if (y < 100) return 2000 + y; return y; }

    function excelSerialToDate(n) {
      if (typeof n !== 'number') return null;
      // Soporte para XLSX serial (1900-based). Usa SSF si existe para mayor seguridad.
      try {
        if (XLSX?.SSF?.parse_date_code) {
          const d = XLSX.SSF.parse_date_code(n);
          if (d) return new Date(d.y, d.m - 1, d.d);
        }
      } catch {}
      const epoch = new Date(Date.UTC(1899, 11, 30)); // Excel weirdness
      const ms = n * 86400000; return new Date(epoch.getTime() + ms);
    }

    function parseFecha(valor) {
      if (!valor && valor !== 0) return null;
      // 1) Date real
      if (Object.prototype.toString.call(valor) === '[object Date]') return valor;
      // 2) Serial Excel
      if (typeof valor === 'number') {
        const d = excelSerialToDate(valor); if (d && !isNaN(d)) return d; return null;
      }
      // 3) String
      const str = String(valor).trim(); if (!str) return null;
      const only = str.split('T')[0].split(' ')[0]; // corta tiempo si viene
      // ISO: yyyy-mm-dd o yyyy/mm/dd
      let m = only.match(/^(\d{4})[-\/.](\d{1,2})[-\/.](\d{1,2})$/);
      if (m) return new Date(Number(m[1]), Number(m[2]) - 1, Number(m[3]));
      // DMY/MDDY con separador - o /
      m = only.match(/^(\d{1,2})[-\/.](\d{1,2})[-\/.](\d{2,4})$/);
      if (m) {
        let a = Number(m[1]), b = Number(m[2]), y = normalizeYear(m[3]);
        let day, month;
        if (a > 12) { day = a; month = b; } // seguro D/M/Y
        else if (b > 12) { day = b; month = a; } // seguro M/D/Y (americano)
        else { day = a; month = b; } // ambos <= 12: preferimos D/M/Y
        return new Date(y, month - 1, day);
      }
      // fallback: intenta Date (puede asumir MM/DD/YYYY en navegadores en-US). Evitamos si es inválido
      const d = new Date(str); return isNaN(d) ? null : d;
    }

    function fechaChileParts(valor, fallbackYear = new Date().getFullYear()) {
      const d = parseFecha(valor);
      let day = '', monthName = '', year = '';
      if (d) {
        day = String(d.getDate()).padStart(2, '0');
        monthName = MESES[d.getMonth()];
        year = String(d.getFullYear());
      } else {
        // si no pudimos parsear, deja en blanco pero sin romper el layout
        day = '—'; monthName = '—'; year = String(fallbackYear);
      }
      return { day, monthName, year };
    }

    // ====== Render de página ======
    function createProformaPage(proforma, id) {
      const page = document.createElement('div');
      page.className = 'proforma-page';
      const { header } = proforma;

      let valorNeto = 0;
      const rowsHtml = proforma.items.map(it => {
        valorNeto += it.TOTAL;
        return `<tr>
          <td class="col-cantidad">${quantityFormatter.format(it.CANTIDAD)}</td>
          <td class="col-detalle">${it.DETALLE || ''}</td>
          <td class="col-punitario">$${numberFormatter.format(it.PUNITARIO)}</td>
          <td class="col-total">${currencyFormatter.format(it.TOTAL)}</td>
        </tr>`;
      }).join('');

      const iva = valorNeto * 0.19;
      const total = valorNeto + iva;

      const { day, monthName, year } = fechaChileParts(header.FECHA, 2025);

      page.innerHTML = `
        <header class="proforma-header">
          <img src="${logoDataUrl || 'https://placehold.co/180x80/eee/ccc?text=Logo'}" alt="Logo" />
          <div class="proforma-title-box">
            <h2 class="proforma-title">FACTURA PROFORMA</h2>
            <p class="proforma-id">Nº ${id}</p>
          </div>
        </header>

        <section class="customer-info">
          <div style="display:flex;gap:.4rem;align-items:center;margin-bottom:6px;padding:3px 6px;">
            <span class="label" style="padding-right:5px;">FECHA,</span>
            <span class="data" style="border-bottom:1px solid #000;width:50px;text-align:center;">${day}</span>
            <span>de</span>
            <span class="data" style="border-bottom:1px solid #000;width:110px;text-align:center;">${monthName}</span>
            <span>de</span>
            <span class="data" style="border-bottom:1px solid #000;width:70px;text-align:center;">${year}</span>
          </div>

          <div class="customer-info-table">
            <table style="width:100%">
              <tbody>
                <tr>
                  <td class="label">SEÑORES:</td>
                  <td class="data">${header.SENORES || ''}</td>
                  <td class="label" style="padding-left:10px;">CIUDAD:</td>
                  <td class="data">${header.CIUDAD || ''}</td>
                </tr>
                <tr>
                  <td class="label">DIRECCION:</td>
                  <td class="data">${header.DIRECCION || ''}</td>
                  <td class="label" style="padding-left:10px;">CREDITO:</td>
                  <td class="data">${header.CREDITO || ''}</td>
                </tr>
                <tr>
                  <td class="label">GIRO:</td>
                  <td class="data">${header.GIRO || ''}</td>
                  <td class="label" style="padding-left:10px;">TELEFONO:</td>
                  <td class="data">${header.TELEFONO || ''}</td>
                </tr>
                <tr>
                  <td class="label">R.U.T.:</td>
                  <td class="data">${header.RUT || ''}</td>
                  <td colspan="2"></td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>

        <div class="table-wrapper">
          <table class="details-table">
            <thead>
              <tr>
                <th class="col-cantidad">CANTIDAD</th>
                <th class="col-detalle">DETALLE</th>
                <th class="col-punitario">P.UNITARIO</th>
                <th class="col-total">TOTAL</th>
              </tr>
            </thead>
            <tbody>${rowsHtml}</tbody>
          </table>
        </div>

        <div style="flex-grow:1;min-height:20px;"></div>

        <section class="totals-section">
          <div class="totals-glosa">
            <span style="font-weight:700;">GLOSA:</span>
            <div style="font-weight:400;padding-left:10px;margin-top:6px;">${header.GLOSA || ''}</div>
          </div>
          <div class="totals-table">
            <table>
              <tbody>
                <tr><td class="label">VALOR NETO</td><td class="value">${currencyFormatter.format(valorNeto)}</td></tr>
                <tr><td class="label">19% IVA</td><td class="value">${currencyFormatter.format(iva)}</td></tr>
                <tr><td class="label">TOTAL</td><td class="value">${currencyFormatter.format(total)}</td></tr>
              </tbody>
            </table>
          </div>
        </section>

        <footer class="proforma-footer">
          <div class="footer-column">
            <span style="font-weight:700;">RECIBI CONFORME</span>
            <div class="footer-line"><span class="label">R.U.T.:</span><span class="data">&nbsp;</span></div>
          </div>
          <div class="footer-column">
            <div class="footer-line"><span class="label">NOMBRE:</span><span class="data">&nbsp;</span></div>
            <div class="footer-line" style="margin-top:10px;"><span class="label">FIRMA:</span><span class="data">&nbsp;</span></div>
          </div>
        </footer>
      `;
      return page;
    }

    function printSelected() {
      const selected = document.querySelectorAll('.proforma-checkbox:checked');
      const printArea = document.getElementById('printArea');
      printArea.innerHTML = '';
      if (!selected.length) { showMessage('error', 'Debes seleccionar al menos una proforma.'); return; }
      selected.forEach(cb => {
        const id = cb.value; const data = proformaData[id];
        if (data) printArea.appendChild(createProformaPage(data, id));
      });
      window.print();
    }
  </script>
</body>
</html>
