<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Impresor de Proformas</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; color: #0f172a; }
    .ui-container { max-width: 900px; margin: 2rem auto; padding: 2rem; background: #fff; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.06); }
    .btn-primary { display: inline-flex; align-items: center; justify-content: center; width: 100%; padding: 0.8rem 1.2rem; font-weight: 600; font-size: 1rem; color: #fff; background: #4f46e5; border: none; border-radius: 0.75rem; transition: background 120ms; cursor: pointer; }
    .btn-primary:hover { background: #4338ca; }
    .btn-primary:disabled { opacity: .5; cursor: not-allowed; }
    .input-file-dropzone { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; min-height: 160px; padding: 1.25rem; text-align: center; background: #fff; border: 2px dashed #cbd5e1; border-radius: 0.75rem; transition: background 120ms, border-color 120ms; cursor: pointer; }
    .input-file-dropzone:hover { background: #f8fafc; border-color: #94a3b8; }
    .input-file-dropzone input[type=file] { display: none; }
    .checkbox-input { width: 1rem; height: 1rem; border-radius: .25rem; border: 1px solid #cbd5e1; }
    #printArea { display: none; }
    .proforma-page { width: 210mm; height: 297mm; padding: 15mm; margin: 0 auto; background: #fff; color: #000; display: flex; flex-direction: column; }
    @page { size: A4; margin: 0; }
    @media print { html, body { width: 210mm; height: 297mm; margin: 0; padding: 0; } .ui-container { display: none; } #printArea { display: block; } .proforma-page { page-break-after: always; } }
  </style>
</head>
<body>
  <div class="ui-container">
    <h1 class="text-3xl font-bold mb-6">Impresor de Proformas</h1>
    <div class="mb-8 p-6 bg-slate-50 rounded-xl border border-slate-200">
      <h2 class="text-xl font-semibold mb-5">1. Cargar Archivos</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label for="fileInput" class="input-file-dropzone">
            <span class="font-medium text-indigo-600">Cargar archivo Excel</span>
            <span class="text-sm text-slate-500 mt-1" id="file-name">o arrastrar y soltar (.xlsx)</span>
            <input id="fileInput" type="file" accept=".xlsx, .xls" />
          </label>
        </div>
        <div>
          <label for="logoInput" class="input-file-dropzone">
            <span class="font-medium text-indigo-600">Cargar logo (Opcional)</span>
            <span class="text-sm text-slate-500 mt-1" id="logo-file-name">o arrastrar y soltar (.png, .jpg)</span>
            <input id="logoInput" type="file" accept="image/*" />
          </label>
        </div>
      </div>
    </div>
    <div id="errorMessage" class="hidden p-4 mb-4 text-sm rounded-lg" role="alert"></div>
    <hr class="my-8 border-slate-200" />
    <div class="mb-8">
      <h2 class="text-xl font-semibold mb-5">2. Seleccionar Proformas</h2>
      <div id="proformaListContainer" class="relative overflow-hidden border border-slate-200 rounded-lg">
        <div class="max-h-64 overflow-y-auto">
          <table class="w-full text-sm text-left text-slate-600">
            <thead class="text-xs text-slate-700 uppercase bg-slate-100 sticky top-0">
              <tr>
                <th class="p-4"><input type="checkbox" id="selectAllCheckbox" class="checkbox-input" /></th>
                <th class="px-6 py-3">ID Proforma</th>
                <th class="px-6 py-3">Cliente</th>
              </tr>
            </thead>
            <tbody id="proformaListBody">
              <tr><td colspan="3" class="px-6 py-4 text-center text-slate-500">Carga un archivo Excel para ver las proformas disponibles.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <hr class="my-8 border-slate-200" />
    <div>
      <h2 class="text-xl font-semibold mb-5">3. Generar Impresión</h2>
      <button id="printButton" class="btn-primary" disabled>Imprimir seleccionadas</button>
    </div>
  </div>
  <div id="printArea"></div>
  <script>
    let proformaData = {}; let logoDataUrl = null;
    const currencyFormatter = new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP', minimumFractionDigits: 0 });
    const numberFormatter = new Intl.NumberFormat('es-ES', { style: 'decimal', minimumFractionDigits: 2 });
    const quantityFormatter = new Intl.NumberFormat('es-ES', { style: 'decimal', minimumFractionDigits: 2 });
    function showMessage(type, message) { const box=document.getElementById('errorMessage'); box.classList.remove('hidden'); box.textContent=message; if(type==='error'){box.className='p-4 mb-4 text-sm rounded-lg bg-red-100 text-red-700';}else if(type==='success'){box.className='p-4 mb-4 text-sm rounded-lg bg-green-100 text-green-700';}else{box.className='hidden';} }
    document.getElementById('logoInput').addEventListener('change',(e)=>{const file=e.target.files?.[0];const label=document.getElementById('logo-file-name');if(!file){label.textContent='o arrastrar y soltar (.png, .jpg)';return;}label.textContent=file.name;const reader=new FileReader();reader.onload=(r)=>{logoDataUrl=r.target.result;showMessage('success',`Logo "${file.name}" cargado correctamente.`);};reader.onerror=()=>{logoDataUrl=null;showMessage('error','No se pudo leer el archivo de logo.');};reader.readAsDataURL(file);});
    document.getElementById('fileInput').addEventListener('change',(e)=>{const file=e.target.files?.[0];const label=document.getElementById('file-name');if(!file){label.textContent='o arrastrar y soltar (.xlsx)';return;}label.textContent=file.name;const reader=new FileReader();reader.onload=(r)=>{try{const data=new Uint8Array(r.target.result);const workbook=XLSX.read(data,{type:'array',cellDates:true});const sheet=workbook.Sheets[workbook.SheetNames[0]];const json=XLSX.utils.sheet_to_json(sheet,{raw:false});processData(json);}catch(err){showMessage('error',`Error al leer el archivo: ${err.message}`);}};reader.onerror=()=>showMessage('error','No se pudo leer el archivo.');reader.readAsArrayBuffer(file);});
    function normalizeKey(key){return(key||'').trim().toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');}
    function processData(rows){proformaData={};if(!rows?.length){showMessage('error','El archivo Excel está vacío.');return;}const headers=Object.keys(rows[0]).map(normalizeKey);const required=['ID_PROFORMA','SENORES','FECHA','CANTIDAD','DETALLE','PUNITARIO'];for(const col of required){if(!headers.includes(col)){showMessage('error',`Falta la columna "${col}".`);return;}}rows.forEach((row)=>{const r={};Object.keys(row).forEach(k=>r[normalizeKey(k)]=row[k]);const id=r.ID_PROFORMA;if(!id)return;if(!proformaData[id])proformaData[id]={header:r,items:[]};const cantidad=parseFloat(String(r.CANTIDAD).replace(',', '.'))||0;const pUnit=parseFloat(String(r.PUNITARIO).replace(',', '.'))||0;proformaData[id].items.push({CANTIDAD:cantidad,DETALLE:r.DETALLE,PUNITARIO:pUnit,TOTAL:cantidad*pUnit});});updateProformaList();showMessage('success',`Se encontraron ${Object.keys(proformaData).length} proformas únicas.`);}
    function updateProformaList(){const body=document.getElementById('proformaListBody');const btn=document.getElementById('printButton');const all=document.getElementById('selectAllCheckbox');if(!Object.keys(proformaData).length){body.innerHTML='<tr><td colspan="3" class="px-6 py-4 text-center text-slate-500">No se encontraron datos.</td></tr>';btn.disabled=true;all.disabled=true;return;}body.innerHTML='';btn.disabled=false;all.disabled=false;all.checked=false;for(const id in proformaData){const pf=proformaData[id];const tr=document.createElement('tr');tr.className='bg-white border-b hover:bg-slate-50';tr.innerHTML=`<td class='w-4 p-4'><input type='checkbox' class='checkbox-input proforma-checkbox' value='${id}' /></td><th class='px-6 py-3 font-semibold text-slate-900 whitespace-nowrap'>${id}</th><td class='px-6 py-3 truncate' style='max-width:20rem;'>${pf.header.SENORES||''}</td>`;body.appendChild(tr);}all.onchange=(e)=>{body.querySelectorAll('.proforma-checkbox').forEach(cb=>cb.checked=e.target.checked);};btn.onclick=printSelected;}
    const MESES=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
    function parseFecha(valor){if(!valor&&valor!==0)return null;if(Object.prototype.toString.call(valor)==='[object Date]')return valor;if(typeof valor==='number'){const epoch=new Date(Date.UTC(1899,11,30));const ms=valor*86400000;return new Date(epoch.getTime()+ms);}const str=String(valor).trim();if(!str)return null;const only=str.split('T')[0].split(' ')[0];let m=only.match(/^(\d{4})[-\/.](\d{1,2})[-\/.](\d{1,2})$/);if(m)return new Date(+m[1],+m[2]-1,+m[3]);m=only.match(/^(\d{1,2})[-\/.](\d{1,2})[-\/.](\d{2,4})$/);if(m){let a=+m[1],b=+m[2],y=+m[3];y=y<100?2000+y:y;let day=a>12?a:b,month=a>12?b:a;if(a<=12&&b<=12){day=a;month=b;}return new Date(y,month-1,day);}const d=new Date(str);return isNaN(d)?null:d;}
    function fechaChileParts(valor){const d=parseFecha(valor);if(!d)return{day:'—',monthName:'—',year:new Date().getFullYear()};return{day:String(d.getDate()).padStart(2,'0'),monthName:MESES[d.getMonth()],year:d.getFullYear()};}
    function createProformaPage(proforma,id){const page=document.createElement('div');page.className='proforma-page';const{header}=proforma;let valorNeto=0;const rowsHtml=proforma.items.map(it=>{valorNeto+=it.TOTAL;return`<tr><td>${quantityFormatter.format(it.CANTIDAD)}</td><td>${it.DETALLE||''}</td><td>$${numberFormatter.format(it.PUNITARIO)}</td><td>${currencyFormatter.format(it.TOTAL)}</td></tr>`;}).join('');const iva=valorNeto*0.19,total=valorNeto+iva;const{day,monthName,year}=fechaChileParts(header.FECHA);page.innerHTML=`<header style='display:flex;justify-content:space-between;border-bottom:2px solid #000;padding-bottom:10px;'><img src='${logoDataUrl||'https://placehold.co/180x80/eee/ccc?text=Logo'}' style='max-width:180px;max-height:80px;object-fit:contain;'/><div style='border:2px solid #000;padding:6px 18px;text-align:center;'><h2 style='font-size:16pt;font-weight:800;margin:0;'>FACTURA PROFORMA</h2><p style='font-size:12pt;font-weight:700;margin:0;'>Nº ${id}</p></div></header><section style='margin-top:10px;font-size:10pt;'><div style='display:flex;gap:.4rem;align-items:center;margin-bottom:6px;padding:3px 6px;'><span>FECHA,</span><span style='border-bottom:1px solid #000;width:50px;text-align:center;'>${day}</span><span>de</span><span style='border-bottom:1px solid #000;width:110px;text-align:center;'>${monthName}</span><span>de</span><span style='border-bottom:1px solid #000;width:70px;text-align:center;'>${year}</span></div></section>`;return page;}
    function printSelected(){const selected=document.querySelectorAll('.proforma-checkbox:checked');const area=document.getElementById('printArea');area.innerHTML='';if(!selected.length){showMessage('error','Debes seleccionar al menos una proforma.');return;}selected.forEach(cb=>{const id=cb.value;const data=proformaData[id];if(data)area.appendChild(createProformaPage(data,id));});window.print();}
  </script>
</body>
</html>
