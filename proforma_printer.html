<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Impresor de Proformas · Bestberry</title>

  <!-- SheetJS (para leer .xlsx) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Tailwind CDN (runtime) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />

  <script>
    /* Configuración rápida de Tailwind (colores y fuente) */
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui'] },
          colors: {
            brand: {
              50: '#eef2ff', 100: '#e0e7ff', 200: '#c7d2fe', 300: '#a5b4fc', 400: '#818cf8',
              500: '#6366f1', 600: '#4f46e5', 700: '#4338ca', 800: '#3730a3', 900: '#312e81'
            }
          },
          boxShadow: {
            soft: '0 10px 25px rgba(2, 6, 23, 0.08)',
          }
        }
      }
    }
  </script>

  <style>
    :root { --ring: rgba(99,102,241,.5); }
    html, body { height: 100%; }
    body { background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%); color: #0f172a; }

    /* ===== Accesibilidad (focus visibles) ===== */
    .focus-ring { outline: none; box-shadow: 0 0 0 2px #fff, 0 0 0 4px var(--ring); }
    .focus-ring:focus-visible { outline: none; box-shadow: 0 0 0 2px #fff, 0 0 0 4px var(--ring); }

    /* ===== Zona de impresión ===== */
    #printArea { display: none; }
    .proforma-page { width: 210mm; height: 297mm; padding: 15mm; margin: 0 auto; background: #fff; color: #000; box-sizing: border-box; display: flex; flex-direction: column; }
    @page { size: A4; margin: 0; }
    @media print {
      html, body { width: 210mm; height: 297mm; margin: 0; padding: 0; }
      .ui-shell { display: none; }
      #printArea { display: block; margin: 0; padding: 0; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .proforma-page { box-shadow: none; border: none; margin: 0; padding: 15mm; page-break-after: always; }
      .proforma-footer, .totals-section { page-break-inside: avoid; }
    }

    /* ===== Proforma (estilo de documento) ===== */
    .proforma-header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid #000; padding-bottom: 10px; }
    .proforma-header img { max-width: 180px; max-height: 80px; object-fit: contain; }
    .proforma-title-box { border: 2px solid #000; padding: 6px 18px; text-align: center; }
    .proforma-title { font-size: 16pt; font-weight: 800; margin: 0; letter-spacing: .5px; }
    .proforma-id { font-size: 12pt; font-weight: 700; margin: 0; }
    .customer-info { margin-top: 10px; font-size: 10pt; }
    .customer-info-table { border-collapse: collapse; width: 100%; }
    .customer-info-table td { padding: 3px 6px; vertical-align: top; }
    .customer-info-table .label { font-weight: 700; white-space: nowrap; padding-right: 5px; width: 1%; }
    .customer-info-table .data { border-bottom: 1px solid #000; }
    .table-wrapper { margin-top: 10px; border: 2px solid #000; border-bottom: none; min-height: 100px; }
    .details-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
    .details-table thead th { border-bottom: 2px solid #000; padding: 8px 5px; text-align: center; font-size: 10pt; font-weight: 700; background: #f2f2f2; }
    .details-table tbody { font-size: 10pt; }
    .details-table tbody tr:first-child td { padding-top: 8px; }
    .details-table tbody tr td { padding: 4px 5px; vertical-align: top; }
    .col-cantidad { width: 15%; text-align: right; padding-right: 10px !important; }
    .col-detalle { width: 50%; }
    .col-punitario { width: 17.5%; text-align: right; padding-right: 10px !important; }
    .col-total { width: 17.5%; text-align: right; padding-right: 10px !important; }
    .totals-section { display: flex; border: 2px solid #000; font-size: 10pt; font-weight: 700; flex-shrink: 0; }
    .totals-glosa { width: 65%; padding: 8px 5px; border-right: 2px solid #000; min-height: 80px; }
    .totals-table { width: 35%; }
    .totals-table table { width: 100%; border-collapse: collapse; }
    .totals-table td { padding: 5px 10px; }
    .totals-table .label { text-align: left; }
    .totals-table .value { text-align: right; }
    .totals-table tr:not(:last-child) td { border-bottom: 1px solid #000; }
    .proforma-footer { margin-top: 10px; border: 2px solid #000; padding: 10px 15px; font-size: 9pt; display: flex; justify-content: space-between; align-items: flex-start; flex-shrink: 0; }
    .footer-column { width: 48%; display: flex; flex-direction: column; justify-content: space-between; height: 50px; }
    .footer-line { display: flex; }
    .footer-line .label { font-weight: 700; padding-right: 5px; white-space: nowrap; }
    .footer-line .data { border-bottom: 1px solid #000; width: 100%; }
  </style>
</head>
<body class="font-sans antialiased">
  <!-- ===== UI SHELL (barra + contenedor) ===== -->
  <div class="ui-shell">
    <header class="sticky top-0 z-40 border-b border-slate-200/70 bg-white/80 backdrop-blur">
      <div class="mx-auto max-w-6xl px-4 py-3 flex items-center justify-between gap-4">
        <div class="flex items-center gap-3">
          <img src="https://placehold.co/36x36/6366f1/fff?text=B" alt="Bestberry" class="h-9 w-9 rounded-lg shadow-soft"/>
          <div>
            <p class="text-sm text-slate-500 leading-none">Bestberry · Herramientas</p>
            <h1 class="font-semibold text-slate-900">Impresor de Proformas</h1>
          </div>
        </div>
        <div class="hidden md:flex items-center gap-2">
          <span id="badgeSelected" class="hidden rounded-full bg-slate-100 px-3 py-1 text-sm font-medium text-slate-700">0 seleccionadas</span>
          <button id="printButton" disabled class="inline-flex items-center gap-2 rounded-xl bg-brand-600 px-4 py-2 text-white font-semibold shadow-soft transition active:translate-y-px disabled:opacity-50 focus-ring">
            <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M6 9V2h12v7M6 18h12v4H6v-4Z"/><path stroke-linecap="round" stroke-linejoin="round" d="M6 14h12m-8-4h4"/></svg>
            Imprimir seleccionadas
          </button>
        </div>
      </div>
    </header>

    <main class="mx-auto max-w-6xl px-4 py-8">
      <!-- Mensajes -->
      <div id="messageHost" class="space-y-3"></div>

      <!-- Paso 1: Cargar archivos -->
      <section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-soft">
        <div class="flex items-start justify-between gap-4">
          <div>
            <h2 class="text-xl font-semibold text-slate-900">1. Cargar archivos</h2>
            <p class="mt-1 text-sm text-slate-600">Sube el Excel con las proformas y, opcionalmente, el logo que irá en el documento.</p>
          </div>
          <span class="hidden md:inline-flex select-none rounded-full bg-brand-50 px-2.5 py-1 text-xs font-semibold text-brand-700">A4 · 300&nbsp;DPI</span>
        </div>

        <div class="mt-6 grid grid-cols-1 gap-6 md:grid-cols-2">
          <!-- Excel -->
          <label for="fileInput" class="group flex min-h-[180px] cursor-pointer flex-col items-center justify-center rounded-2xl border-2 border-dashed border-slate-300 bg-slate-50/60 p-6 text-center transition hover:border-brand-300 hover:bg-brand-50/40 focus-within:border-brand-400">
            <svg class="mb-3 h-10 w-10 text-slate-400 transition group-hover:text-brand-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m.75 12l3 3m0 0l3-3m-3 3v-6m-1.5-9H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/></svg>
            <div class="font-medium text-brand-700">Cargar archivo Excel</div>
            <div id="file-name" class="mt-1 text-sm text-slate-500">o arrastrar y soltar (.xlsx)</div>
            <input id="fileInput" type="file" accept=".xlsx, .xls" class="sr-only"/>
          </label>

          <!-- Logo -->
          <label for="logoInput" class="group flex min-h-[180px] cursor-pointer flex-col items-center justify-center rounded-2xl border-2 border-dashed border-slate-300 bg-slate-50/60 p-6 text-center transition hover:border-brand-300 hover:bg-brand-50/40 focus-within:border-brand-400">
            <svg class="mb-3 h-10 w-10 text-slate-400 transition group-hover:text-brand-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm16.5-1.5H3.75v-1.5m16.5 0v1.5m0 0v-1.5m0 0h-16.5"/></svg>
            <div class="font-medium text-brand-700">Cargar logo (opcional)</div>
            <div id="logo-file-name" class="mt-1 text-sm text-slate-500">o arrastrar y soltar (.png, .jpg)</div>
            <input id="logoInput" type="file" accept="image/*" class="sr-only" />
          </label>
        </div>
      </section>

      <!-- Paso 2: Selección de proformas -->
      <section class="mt-8 rounded-2xl border border-slate-200 bg-white p-6 shadow-soft">
        <h2 class="text-xl font-semibold text-slate-900">2. Seleccionar proformas</h2>
        <div class="mt-4 overflow-hidden rounded-xl border border-slate-200">
          <div class="max-h-72 overflow-y-auto">
            <table class="w-full text-sm text-left text-slate-700">
              <thead class="sticky top-0 z-10 bg-slate-50/95 uppercase tracking-wide text-xs border-b border-slate-200">
                <tr>
                  <th class="p-3 w-12"><input type="checkbox" id="selectAllCheckbox" class="h-4 w-4 rounded border-slate-300 text-brand-600 focus-ring"/></th>
                  <th class="px-4 py-3">ID Proforma</th>
                  <th class="px-4 py-3">Cliente</th>
                </tr>
              </thead>
              <tbody id="proformaListBody">
                <tr class="bg-white">
                  <td colspan="3" class="px-6 py-6 text-center text-slate-500">Carga un archivo Excel para ver las proformas disponibles.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="mt-4 flex items-center justify-between">
          <p class="text-sm text-slate-600">
            Consejo: puedes buscar con <kbd class="rounded bg-slate-100 px-1.5 py-0.5 text-[11px]">Ctrl</kbd> + <kbd class="rounded bg-slate-100 px-1.5 py-0.5 text-[11px]">F</kbd> si la lista es larga.
          </p>
          <button id="printButtonSm" disabled class="inline-flex items-center gap-2 rounded-xl bg-brand-600 px-4 py-2 text-white font-semibold shadow-soft transition active:translate-y-px disabled:opacity-50 focus-ring md:hidden">
            <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M6 9V2h12v7M6 18h12v4H6v-4Z"/><path stroke-linecap="round" stroke-linejoin="round" d="M6 14h12m-8-4h4"/></svg>
            Imprimir seleccionadas
          </button>
        </div>
      </section>

      <!-- Paso 3: Generar -->
      <section class="mt-8 rounded-2xl border border-slate-200 bg-white p-6 shadow-soft">
        <h2 class="text-xl font-semibold text-slate-900">3. Generar impresión</h2>
        <div class="mt-4 grid grid-cols-1 gap-4 md:grid-cols-2">
          <div class="rounded-xl bg-slate-50 p-4 text-sm text-slate-600">
            <p><span class="font-semibold text-slate-800">Formato:</span> A4, orientación vertical.</p>
            <p class="mt-1">Se aplica <em>print-color-adjust</em> para preservar colores en cabeceras.</p>
          </div>
          <div class="rounded-xl bg-slate-50 p-4 text-sm text-slate-600">
            <p><span class="font-semibold text-slate-800">Totales:</span> usa IVA 19% por defecto.</p>
            <p class="mt-1">Los valores se formatean en CLP (sin decimales).</p>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Área de impresión (solo al imprimir) -->
  <div id="printArea"></div>

  <script>
    let proformaData = {};
    let logoDataUrl = null;

    // ===== Utilidades de formato =====
    const currencyFormatter = new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP', minimumFractionDigits: 0, maximumFractionDigits: 0, });
    const numberFormatter = new Intl.NumberFormat('es-ES', { style: 'decimal', minimumFractionDigits: 2, maximumFractionDigits: 2, });
    const quantityFormatter = new Intl.NumberFormat('es-ES', { style: 'decimal', minimumFractionDigits: 2, maximumFractionDigits: 2, });

    // ===== Mensajes (toast simple) =====
    function showToast(type, message) {
      const host = document.getElementById('messageHost');
      const base = document.createElement('div');
      base.className = 'flex items-start gap-3 rounded-xl border p-4 shadow-soft';
      const iconWrap = document.createElement('div');
      iconWrap.className = 'mt-0.5 inline-flex h-6 w-6 items-center justify-center rounded-full';
      const text = document.createElement('div');
      text.className = 'text-sm';
      text.textContent = message;

      if (type === 'error') {
        base.classList.add('border-red-200', 'bg-red-50');
        iconWrap.classList.add('bg-red-100', 'text-red-700');
        iconWrap.innerHTML = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>';
      } else {
        base.classList.add('border-emerald-200', 'bg-emerald-50');
        iconWrap.classList.add('bg-emerald-100', 'text-emerald-700');
        iconWrap.innerHTML = '<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>';
      }
      base.appendChild(iconWrap); base.appendChild(text);
      host.appendChild(base);
      setTimeout(() => base.remove(), 4000);
    }

    // ===== Logo =====
    document.getElementById('logoInput').addEventListener('change', (event) => {
      const file = event.target.files?.[0];
      const labelSpan = document.getElementById('logo-file-name');
      if (!file) { labelSpan.textContent = 'o arrastrar y soltar (.png, .jpg)'; return; }
      labelSpan.textContent = file.name;
      const reader = new FileReader();
      reader.onload = (e) => { logoDataUrl = e.target.result; showToast('ok', `Logo "${file.name}" cargado correctamente.`); };
      reader.onerror = () => { logoDataUrl = null; showToast('error', 'No se pudo leer el archivo de logo.'); };
      reader.readAsDataURL(file);
    });

    // ===== Excel =====
    document.getElementById('fileInput').addEventListener('change', (event) => {
      const file = event.target.files?.[0];
      const labelSpan = document.getElementById('file-name');
      if (!file) { labelSpan.textContent = 'o arrastrar y soltar (.xlsx)'; return; }
      labelSpan.textContent = file.name;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array', cellDates: true });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(sheet, { raw: false });
          processData(json);
        } catch (err) {
          console.error(err);
          showToast('error', `Error al leer el archivo: ${err.message}`);
        }
      };
      reader.onerror = () => showToast('error', 'No se pudo leer el archivo.');
      reader.readAsArrayBuffer(file);
    });

    function normalizeKey(key) {
      return (key || '').trim().toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    }

    function processData(rows) {
      proformaData = {};
      if (!rows?.length) { showToast('error', 'El archivo Excel está vacío.'); return; }
      const headers = Object.keys(rows[0]).map(normalizeKey);
      const required = ['ID_PROFORMA', 'SENORES', 'FECHA', 'CANTIDAD', 'DETALLE', 'PUNITARIO'];
      for (const col of required) {
        if (!headers.includes(col)) { showToast('error', `Falta la columna "${col}".`); return; }
      }

      rows.forEach((row) => {
        const r = {}; Object.keys(row).forEach(k => r[normalizeKey(k)] = row[k]);
        const id = r.ID_PROFORMA; if (!id) return;
        if (!proformaData[id]) proformaData[id] = { header: r, items: [] };
        const cantidad = parseFloat(String(r.CANTIDAD).replace(',', '.')) || 0;
        const pUnit = parseFloat(String(r.PUNITARIO).replace(',', '.')) || 0;
        proformaData[id].items.push({ CANTIDAD: cantidad, DETALLE: r.DETALLE, PUNITARIO: pUnit, TOTAL: cantidad * pUnit });
      });

      updateProformaList();
      showToast('ok', `Se encontraron ${Object.keys(proformaData).length} proformas únicas.`);
    }

    function updateProformaList() {
      const body = document.getElementById('proformaListBody');
      const btn = document.getElementById('printButton');
      const btnSm = document.getElementById('printButtonSm');
      const all = document.getElementById('selectAllCheckbox');
      const badge = document.getElementById('badgeSelected');

      if (!Object.keys(proformaData).length) {
        body.innerHTML = '<tr><td colspan="3" class="px-6 py-6 text-center text-slate-500">No se encontraron datos.</td></tr>';
        btn.disabled = true; btnSm.disabled = true; all.disabled = true; badge.classList.add('hidden'); return;
      }
      body.innerHTML = '';
      btn.disabled = false; btnSm.disabled = false; all.disabled = false; all.checked = false;

      for (const id in proformaData) {
        const pf = proformaData[id];
        const tr = document.createElement('tr');
        tr.className = 'bg-white border-b border-slate-200 hover:bg-slate-50';
        tr.innerHTML = `
          <td class="w-12 p-3"><input type="checkbox" class="proforma-checkbox h-4 w-4 rounded border-slate-300 text-brand-600 focus-ring" value="${id}"/></td>
          <th class="px-4 py-3 font-semibold text-slate-900 whitespace-nowrap">${id}</th>
          <td class="px-4 py-3 truncate" style="max-width: 28rem;">${pf.header.SENORES || ''}</td>`;
        body.appendChild(tr);
      }

      all.onchange = (e) => {
        body.querySelectorAll('.proforma-checkbox').forEach(cb => cb.checked = e.target.checked);
        updateBadge();
      };
      body.addEventListener('change', (e) => {
        if (e.target.classList?.contains('proforma-checkbox')) updateBadge();
      });

      function updateBadge() {
        const count = document.querySelectorAll('.proforma-checkbox:checked').length;
        if (count > 0) { badge.textContent = `${count} seleccionada${count>1?'s':''}`; badge.classList.remove('hidden'); }
        else { badge.classList.add('hidden'); }
      }

      document.getElementById('printButton').onclick = printSelected;
      document.getElementById('printButtonSm').onclick = printSelected;
    }

    // ===== Fecha (Chile) =====
    const MESES = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
    function normalizeYear(y) { y = Number(y); if (y < 100) return 2000 + y; return y; }
    function excelSerialToDate(n) {
      if (typeof n !== 'number') return null;
      try {
        if (XLSX?.SSF?.parse_date_code) {
          const d = XLSX.SSF.parse_date_code(n);
          if (d) return new Date(d.y, d.m - 1, d.d);
        }
      } catch {}
      const epoch = new Date(Date.UTC(1899, 11, 30));
      const ms = n * 86400000; return new Date(epoch.getTime() + ms);
    }
    function parseFecha(valor) {
      if (!valor && valor !== 0) return null;
      if (Object.prototype.toString.call(valor) === '[object Date]') return valor;
      if (typeof valor === 'number') { const d = excelSerialToDate(valor); return (d && !isNaN(d)) ? d : null; }
      const str = String(valor).trim(); if (!str) return null;
      const only = str.split('T')[0].split(' ')[0];
      let m = only.match(/^(\d{4})[-\/.](\d{1,2})[-\/.](\d{1,2})$/);
      if (m) return new Date(Number(m[1]), Number(m[2]) - 1, Number(m[3]));
      m = only.match(/^(\d{1,2})[-\/.](\d{1,2})[-\/.](\d{2,4})$/);
      if (m) {
        let a = Number(m[1]), b = Number(m[2]), y = normalizeYear(m[3]);
        let day, month;
        if (a > 12) { day = a; month = b; }
        else if (b > 12) { day = b; month = a; }
        else { day = a; month = b; }
        return new Date(y, month - 1, day);
      }
      const d = new Date(str); return isNaN(d) ? null : d;
    }
    function fechaChileParts(valor, fallbackYear = new Date().getFullYear()) {
      const d = parseFecha(valor);
      let day = '', monthName = '', year = '';
      if (d) { day = String(d.getDate()).padStart(2, '0'); monthName = MESES[d.getMonth()]; year = String(d.getFullYear()); }
      else { day = '—'; monthName = '—'; year = String(fallbackYear); }
      return { day, monthName, year };
    }

    // ===== Render de página =====
    function createProformaPage(proforma, id) {
      const page = document.createElement('div');
      page.className = 'proforma-page';
      const { header } = proforma;

      let valorNeto = 0;
      const rowsHtml = proforma.items.map(it => {
        valorNeto += it.TOTAL;
        return `<tr>
          <td class="col-cantidad">${quantityFormatter.format(it.CANTIDAD)}</td>
          <td class="col-detalle">${it.DETALLE || ''}</td>
          <td class="col-punitario">$${numberFormatter.format(it.PUNITARIO)}</td>
          <td class="col-total">${currencyFormatter.format(it.TOTAL)}</td>
        </tr>`;
      }).join('');

      const iva = valorNeto * 0.19;
      const total = valorNeto + iva;
      const { day, monthName, year } = fechaChileParts(header.FECHA, 2025);

      page.innerHTML = `
        <header class="proforma-header">
          <img src="${logoDataUrl || 'https://placehold.co/180x80/eee/ccc?text=Logo'}" alt="Logo" />
          <div class="proforma-title-box">
            <h2 class="proforma-title">FACTURA PROFORMA</h2>
            <p class="proforma-id">Nº ${id}</p>
          </div>
        </header>

        <section class="customer-info">
          <div style="display:flex;gap:.4rem;align-items:center;margin-bottom:6px;padding:3px 6px;">
            <span class="label" style="padding-right:5px;">FECHA,</span>
            <span class="data" style="border-bottom:1px solid #000;width:50px;text-align:center;">${day}</span>
            <span>de</span>
            <span class="data" style="border-bottom:1px solid #000;width:110px;text-align:center;">${monthName}</span>
            <span>de</span>
            <span class="data" style="border-bottom:1px solid #000;width:70px;text-align:center;">${year}</span>
          </div>

          <div class="customer-info-table">
            <table style="width:100%">
              <tbody>
                <tr>
                  <td class="label">SEÑORES:</td>
                  <td class="data">${header.SENORES || ''}</td>
                  <td class="label" style="padding-left:10px;">CIUDAD:</td>
                  <td class="data">${header.CIUDAD || ''}</td>
                </tr>
                <tr>
                  <td class="label">DIRECCION:</td>
                  <td class="data">${header.DIRECCION || ''}</td>
                  <td class="label" style="padding-left:10px;">CREDITO:</td>
                  <td class="data">${header.CREDITO || ''}</td>
                </tr>
                <tr>
                  <td class="label">GIRO:</td>
                  <td class="data">${header.GIRO || ''}</td>
                  <td class="label" style="padding-left:10px;">TELEFONO:</td>
                  <td class="data">${header.TELEFONO || ''}</td>
                </tr>
                <tr>
                  <td class="label">R.U.T.:</td>
                  <td class="data">${header.RUT || ''}</td>
                  <td colspan="2"></td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>

        <div class="table-wrapper">
          <table class="details-table">
            <thead>
              <tr>
                <th class="col-cantidad">CANTIDAD</th>
                <th class="col-detalle">DETALLE</th>
                <th class="col-punitario">P.UNITARIO</th>
                <th class="col-total">TOTAL</th>
              </tr>
            </thead>
            <tbody>${rowsHtml}</tbody>
          </table>
        </div>

        <div style="flex-grow:1;min-height:20px;"></div>

        <section class="totals-section">
          <div class="totals-glosa">
            <span style="font-weight:700;">GLOSA:</span>
            <div style="font-weight:400;padding-left:10px;margin-top:6px;">${header.GLOSA || ''}</div>
          </div>
          <div class="totals-table">
            <table>
              <tbody>
                <tr><td class="label">VALOR NETO</td><td class="value">${currencyFormatter.format(valorNeto)}</td></tr>
                <tr><td class="label">19% IVA</td><td class="value">${currencyFormatter.format(iva)}</td></tr>
                <tr><td class="label">TOTAL</td><td class="value">${currencyFormatter.format(total)}</td></tr>
              </tbody>
            </table>
          </div>
        </section>

        <footer class="proforma-footer">
          <div class="footer-column">
            <span style="font-weight:700;">RECIBI CONFORME</span>
            <div class="footer-line"><span class="label">R.U.T.:</span><span class="data">&nbsp;</span></div>
          </div>
          <div class="footer-column">
            <div class="footer-line"><span class="label">NOMBRE:</span><span class="data">&nbsp;</span></div>
            <div class="footer-line" style="margin-top:10px;"><span class="label">FIRMA:</span><span class="data">&nbsp;</span></div>
          </div>
        </footer>
      `;
      return page;
    }

    function printSelected() {
      const selected = document.querySelectorAll('.proforma-checkbox:checked');
      const printArea = document.getElementById('printArea');
      printArea.innerHTML = '';
      if (!selected.length) { showToast('error', 'Debes seleccionar al menos una proforma.'); return; }
      selected.forEach(cb => {
        const id = cb.value; const data = proformaData[id];
        if (data) printArea.appendChild(createProformaPage(data, id));
      });
      window.print();
    }
  </script>
</body>
</html>
